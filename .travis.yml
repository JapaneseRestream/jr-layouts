language: minimal
services:
  - docker

env:
  global:
    - DISCORD_WEBHOOK_SCRIPT: https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh

before_script:
  - make docker-login

script:
  - make docker-build

after_success:
  - curl -sfL "$DISCORD_WEBHOOK_SCRIPT" > /tmp/send.sh
  - chmod +x /tmp/send.sh
  - /tmp/send.sh success $DISCORD_WEBHOOK_URL

after_failure:
  - curl -sfL "$DISCORD_WEBHOOK_SCRIPT" > /tmp/send.sh
  - chmod +x /tmp/send.sh
  - /tmp/send.sh failure $DISCORD_WEBHOOK_URL

before_deploy:
  - eval "$(ssh-agent -s)"

deploy:
  - provider: script
    script: make docker-push-branch
    on:
      all_branches: true
  - provider: script
    script: make docker-push-latest
    on:
      branch: master
  - provider: script
    script: make deploy-staging
    on:
      branch: master

after_deploy:
  - curl -XPOST $IMAGE_REFRESH_WEBHOOK_URL
